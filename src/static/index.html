<div class='container'>
    <div class='row'>
        <div class='col-md-12'>
            <div style="#{user_logged_in? ? 'display: none;' : ''}">
                <h1>
                    Willkommen zum Workspace der Hackschule!
                </h1>
                <p>
                    Hier bekommst du deine eigene Programmierumgebung, in der du direkt loslegen kannst, egal ob in Java, Python, Ruby, JavaScript, C oder C++.
                </p>
            </div>
            <div id='div_control_panel' class='mt-5' style="text-align: center; #{user_logged_in? ? '' : 'display: none;'}">
                <div>
                    <button id='bu_launch' class="btn btn-lg btn-success"><i class='fa fa-code'></i>&nbsp;&nbsp;Workspace öffnen</button>
                </div>
                <div class="mt-2">
                    <!-- <button id='bu_restart' class="btn btn btn-warning"><i class='fa fa-refresh'></i>&nbsp;&nbsp;Workspace neustarten</button> -->
                    <button id='bu_reset' class="btn btn btn-danger"><i class='fa fa-trash'></i>&nbsp;&nbsp;Workspace zurücksetzen</button>
                </div>
            </div>
            <div id="div_admin" style="#{admin_logged_in? ? '' : 'display: none;'}">
                <h2>Administration</h2>
                #{print_admin_info()}
            </div>
        </div>
    </div>
</div>
<script>
    var user_tag = "#{@session_user.nil? ? '' : tag_for_email((@session_user || {})[:email])}";
    function check_server_online() {
        fetch(`/${user_tag}/`) // replace with your actual API endpoint
        .then(response => {
            if (response.status === 200) {
                console.log('Server is online');
                window.location.href = `/${user_tag}/`;
        } else {
                console.log('Server is offline');
                setTimeout(function() { check_server_online(); }, 500);
            }
        })
        .catch(error => {
            console.log('Error:', error);
        });
    }

    window.addEventListener('load', function() {
        establish_websocket_connection();
        $('#bu_launch').on('click', function(e) {
            $('#bu_launch .fa').addClass('fa-spin');
            api_call('/api/start_server', {}, function(data) {
                check_server_online();
            });
            // window.location.href = `/${user_tag}/`;
        });
        $('#bu_reset').on('click', function(e) {
            // $('#bu_launch .fa').addClass('fa-spin');
            api_call('/api/reset_server', {}, function(data) {
            });
            // window.location.href = `/${user_tag}/`;
        });
    });

    function establish_websocket_connection() {
        var ws_uri = 'ws://' + location.host + '/ws';
        if (location.host !== 'localhost:8025')
            ws_uri = 'wss://' + location.host + '/ws';
        ws = new WebSocket(ws_uri);
        setup_ws(ws);
    }

    function keepAlive() {
        var timeout = 20000;
        if (ws.readyState == ws.OPEN) {
            ws.send('');
        }
        (function() {
            timerId = setTimeout(keepAlive, timeout);
        })();
    }

    function setup_ws(ws)
    {
        ws.onopen = function () {
            console.log('WS connection established');
            keepAlive();
        }

        ws.onclose = function () {
            console.log('WS connection closed');
            $('.please-reload').fadeIn();
            clearTimeout(timerId);
        }

        ws.onmessage = function (msg) {
            data = JSON.parse(msg.data);
            console.log(data);
            if (data.action === 'update_state') {
                // if (data.state.running) {
                //     $('#div_state_on').show();
                //     $('#div_state_off').hide();
                //     $('#bu_start_server').prop('disabled', true);
                //     $('#bu_stop_server').prop('disabled', false);
                //     $('#bu_launch').prop('disabled', false);
                // } else {
                //     $('#div_state_on').hide();
                //     $('#div_state_off').show();
                //     $('#bu_start_server').prop('disabled', false);
                //     $('#bu_stop_server').prop('disabled', true);
                //     $('#bu_launch').prop('disabled', true);
                // }
                // $('#div_control_panel').show();

                console.log(data.state);
            }
        }
    }
</script>
