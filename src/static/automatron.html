<div class="container">
  <div class="col-md-12">
    <h2>Automatron</h2>

    <!-- Examples -->
    <div class="mb-3">
      <div class="row" id="examples_list"></div>
    </div>

    <h3>Regulärer Ausdruck</h3>
    <!-- Input -->
    <div class="input-group mb-3">
      <input class="form-control" type="text" id="ti_input" placeholder="Gib einen regulären Ausdruck ein...">
      <button class="btn btn-primary" id="btn_process">Send</button>
    </div>

    <div id="output_area" class="mb-3"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

const exampleGroups = {
  "Einfach": [
    { regex: 'a|b',               desc: 'Vereinigung' },
    { regex: 'ab',                desc: 'Verkettung' },
    { regex: 'a*',                desc: "K<span style='font-size: 80%;'>LEEN</span>sche Hülle" },
    { regex: 'a+',                desc: 'Positive Hülle (mindestens ein a)' },
    { regex: '.',                 desc: 'ein beliebiges Zeichen' },
    { regex: '[ab]',              desc: 'einzelnes a oder b' },
    { regex: '[a-c]',             desc: 'ein Zeichen von a bis c' }
  ],

"Etwas schwerer": [
    { regex: '(a|b)*c',           desc: 'alle Wörter, die auf c enden' },
    { regex: 'a(b|c)',            desc: 'a gefolgt von b oder c' },
    { regex: '(a|b)+',            desc: 'alle nichtleeren Wörter über {a,b}' },
    { regex: '(a|b)*(ab|ba)',     desc: 'endet auf ab oder ba' },
    { regex: '[ab]{2,4}',         desc: 'Wörter der Länge 2 bis 4 über a,b' },
    { regex: 'a?b',               desc: 'optional ein a, gefolgt von b' }
  ],

"Mittel": [
    { regex: '(ab)+',             desc: 'mindestens einmal "ab" hintereinander' },
    { regex: 'a+b+',              desc: 'mindestens ein a, danach mindestens ein b' },
    { regex: 'a*b*a*',            desc: 'höchstens ein Block von b’s in der Mitte' },
    { regex: '(a|b)*aa',          desc: 'endet auf aa' },
    { regex: '(a|b)*bb',          desc: 'endet auf bb' },
    { regex: 'a(b|ab)*a',         desc: 'beginnt und endet mit a, dazwischen b oder ab' }
  ],

"Schwerer": [
    { regex: '(a|b)*abb',         desc: 'endet auf abb' },
    { regex: '(a|b)*aba(a|b)*',   desc: 'enthält "aba"' },
    { regex: '(aa|bb)+',          desc: 'gerade Länge aus Paaren, mindestens 2 Zeichen' },
    { regex: '(ab|ba)+',          desc: 'abwechselnd in Paaren, mindestens 2 Zeichen' },
    { regex: '(a|b)*bba(a|b)*',   desc: 'enthält bba' },
    { regex: '(a|b){3,6}',        desc: 'Wörter mit Länge 3 bis 6' }
  ],

"Binärzahlen": [
    { regex: '(0|1)*1(0|1)(0|1)', desc: 'drittletztes Symbol ist 1' },
    { regex: '(0|1)*01(0|1)*',    desc: 'enthält 01' },
    { regex: '(0|1)*(00|11)(0|1)*', desc: 'enthält 00 oder 11' },
    { regex: '(00|11)+',          desc: 'mindestens ein Doppel (00 oder 11)' },
    { regex: '1*0*1',             desc: 'beginnt mit beliebig vielen 1, endet auf 1' },
    { regex: '(10)+',              desc: 'abwechselnd 1 und 0, mindestens einmal' }
  ],

"Anspruchsvoll": [
    { regex: '(a|b)*a(a|b)*a(a|b)*',             desc: 'mindestens zwei a’s' },
    { regex: '(a|b)*a(a|b)*a(a|b)*a(a|b)*',      desc: 'mindestens drei a’s' },
    { regex: 'b*(ab*ab*)+',                      desc: 'gerade Anzahl von a’s (≥ 2 a’s)' },
    { regex: 'b*(ab*ab*ab*)+',                   desc: 'Anzahl der a’s durch 3 teilbar (≥ 3 a’s)' },
    { regex: '(a|b)*(aba|bab)(a|b)*',           desc: 'enthält aba oder bab' },
    { regex: '(aa|bb|ab|ba){2,}',                desc: 'mindestens zwei beliebige Paare' }
  ] 
};



  const $list = $('#examples_list');
  Object.entries(exampleGroups).forEach(([group, items], idx) => {
    const $col = $('<div class="col-md-6 mb-3"></div>');
    $col.append(`<h6 class="mt-3">${group}</h6>`);
    const $grp = $('<div class="list-group"></div>');
    items.forEach(ex => {
      const $item = $(`
        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          <span><code>${ex.regex}</code> — ${ex.desc}</span>
          <span class="badge bg-secondary">Run</span>
        </button>
      `);
      $item.on('click', () => {
        $('#ti_input').val(ex.regex);
        processRegex(ex.regex);
        $list.find('.active').removeClass('active');
        $item.addClass('active');
      });
      $grp.append($item);
    });
    $col.append($grp);
    $list.append($col);
  });

  $('#ti_input').on('keypress', function(e) {
    if (e.which == 13) $('#btn_process').click();
  });
  $('#btn_process').on('click', function() {
    const input = $('#ti_input').val();
    processRegex(input);
  });

  function processRegex(input) {
    if (!input || !input.trim()) return;
    const $btn = $('#btn_process');
    // $btn.prop('disabled', true).text('Working…');

    api_call('/api/automatron', { regex: input }, function(data) {
      console.log(data);
      const $out = $('#output_area');
      $out.empty();

      $out.append($('<h3>').html('Regulärer Ausdruck &rightarrow; &epsilon;-NEA (Thompson-Konstruktion)'));
      $out.append($(data.nfa.svg).css('max-width', '100%'));

      $out.append($('<h3>').html('Potenzmengenkonstruktion (&epsilon;-NEA &rightarrow; DEA)'));
      $out.append($(data.notes_subset_html));
      $out.append($(data.dfa.implicit_sink.svg).css('max-width', '100%'));
      if (data.dfa.implicit_sink.has_sink) {
        $out.append($("<div class='mt-3'>").html(
          '<em>(nicht dargestellte Übergänge führen in einen impliziten Fehlerzustand)</em>'
        ));
      }

      $out.append($('<h3>').html('DEA &rightarrow; minimierter DEA (Tabellenverfahren)'));
      $out.append($(data.notes_minimization_html));
      $out.append($(data.min_dfa.implicit_sink.svg).css('max-width', '100%'));
      if (data.min_dfa.implicit_sink.has_sink) {
        $out.append($("<div class='mt-3'>").html(
          '<em>(nicht dargestellte Übergänge führen in einen impliziten Fehlerzustand)</em>'
        ));
      }

      $out.append($('<h3>').text('Reguläre Grammatik'));
      $out.append($('<div>').html(data.grammar));

      $out.append($('<h3>').text('Reguläre Grammatik (vereinfacht)'));
      $out.append($('<div>').html(data.grammar_compact));

      $out.append($('<h3>').html("<i class='bi bi-check text-success mr-2'></i>&nbsp;Wörter, die zur Sprache gehören"));
      $out.append($(data.samples_positive.map(x => `<code>${x}</code>&nbsp;`).join(' ')));

      $out.append($('<h3>').html("<i class='bi bi-x text-danger mr-2'></i>&nbsp;Wörter, die <em>nicht</em> zur Sprache gehören"));
      $out.append($(data.samples_negative.map(x => `<code>${x}</code>&nbsp;`).join(' ')));
    }, function onError(err) {
      const $out = $('#output_area');
      $out.empty().append(
        $('<div class="alert alert-danger" role="alert">')
          .text('Error: ' + (err?.message || 'Request failed'))
      );
    });
  }
});
</script>
