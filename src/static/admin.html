#{ assert(teacher_logged_in?) }

<style>
    .table tr {
        transition: background-color 0.5s ease-out;
    }

    .table>:not(caption)>*>* {
        background: none;
    }

    .unit {
        /* font-weight: bold; */
        margin-left: 0.15em;
        font-size: 90%;
        opacity: 0.7;
    }

    .server-stats {
        border: 1px solid rgba(0, 0, 0, 0.1);
        position: relative;
        padding: 1em;
        border-radius: 1em;
        box-shadow: 0 0 0.5em rgba(0, 0, 0, 0.075);

        h4 {
            opacity: 0.7;
        }

        .bi {
            position: absolute;
            top: 0.1em;
            right: 0.3em;
            font-size: 220%;
            opacity: 0.33;
        }

        p {
            text-justify: left;
            overflow-x: hidden;
            white-space: pre;
            margin: 0.5rem 0 0 0;
        }
    }

    .user_pill {
        padding: 0 0.2em;
        border-radius: 2px;
    }
</style>
<div class='container'>
    <div class='row'>
        <div class='col-md-12'>
            <div id="login_codes_here" style="display: none;">
                <h2>Anmelde-Codes</h2>
                <div style="max-width: 100%; overflow-x: auto;">
                    <table class="table table-sm" id="table_admin_workspaces">
                        <thead>
                            <tr>
                                <th>E-Mail</th>
                                <th>Code</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <h2>Server</h2>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="server-stats" id="stats-cpu">
                        <h4>CPU / RAM</h4>
                        <i class='bi bi-cpu'></i>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                CPU
                                <div class="progress" role="progressbar">
                                    <div class="progress-bar progress-bar-striped" style="width: 0%"></div>
                                </div>
                                <p>&nbsp;</p>
                            </div>
                            <div class="col-md-6">
                                RAM
                                <div class="progress" role="progressbar">
                                    <div class="progress-bar progress-bar-striped" style="width: 0%"></div>
                                </div>
                                <p>&nbsp;</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="server-stats" id="stats-storage">
                        <h4>Storage</h4>
                        <i class='bi bi-nvme'></i>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                System
                                <div class="progress" role="progressbar">
                                    <div class="progress-bar progress-bar-striped" style="width: 0%"></div>
                                </div>
                                <p>&nbsp;</p>
                            </div>
                            <div class="col-md-6">
                                User data
                                <div class="progress" role="progressbar">
                                    <div class="progress-bar progress-bar-striped" style="width: 0%"></div>
                                </div>
                                <p>&nbsp;</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h2>Workspaces</h2>
            <div id="active_users_here"></div>
            #{print_workspaces()}
        </div>
    </div>
</div>

<script>

    var invitations = #{@@invitations.to_json};
    var group_order = #{@@user_groups.keys.to_json};

    function wrapLettersInSpan(input) {
        return input.replace(/([A-Za-z%]+)/g, "<span class='unit'>$1</span>");
    }

    function keepAlive() {
        var timeout = 20000;
        if (ws.readyState == ws.OPEN) {
            ws.send('');
        }
        (function () {
            window.timerId = setTimeout(keepAlive, timeout);
        })();
    }

    function setup_ws(ws) {
        ws.onopen = function () {
            console.log('WS connection established');
            // ws.send(JSON.stringify({'hello': 'world'}));
            keepAlive();
        }

        ws.onclose = function () {
            console.log('WS connection closed');
            $('.please-reload').fadeIn();
            clearTimeout(window.timerId);
        }

        // Simple hash function to turn a string into a number
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        // Convert hash to HSL color
        function stringToColor(str) {
            const hash = hashString(str);
            const h = Math.abs(hash) % 360; // hue between 0-359
            const s = 40;                   // saturation (fixed for vivid colors)
            const l = 50;                   // lightness (balanced)
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        // Compute luminance to decide black/white text
        function getContrastColor(hsl) {
            // Convert HSL to RGB first
            const hslMatch = hsl.match(/hsl\((\d+), (\d+)%?, (\d+)%?\)/);
            let [_, h, s, l] = hslMatch.map(Number);
            h /= 360;
            s /= 100;
            l /= 100;

            // HSL â†’ RGB conversion
            const a = s * Math.min(l, 1 - l);
            function f(n) {
                const k = (n + h * 12) % 12;
                const c = l - a * Math.max(-1, Math.min(k - 3, Math.min(9 - k, 1)));
                return Math.round(255 * c);
            }
            const [r, g, b] = [f(0), f(8), f(4)];

            // Relative luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

            return luminance > 0.6 ? "#000000" : "#FFFFFF";
        }

        // Main function: takes a string, returns { background, color }
        function getUserColors(name) {
            const background = stringToColor(name);
            const color = getContrastColor(background);
            return { background, color };
        }

        ws.onmessage = function (msg) {
            data = JSON.parse(msg.data);
            if (data.server_stats) {
                let stats = data.server_stats;
                $('#stats-cpu p').eq(0).html(`${stats.cpu_usage.toFixed(2)}% of ${stats.num_cores} cores`);
                $('#stats-cpu .progress-bar').eq(0).css('width', `${stats.cpu_usage}%`);
                $('#stats-cpu p').eq(1).html(`${stats.ram_used} of ${stats.ram_total}`);
                $('#stats-cpu .progress-bar').eq(1).css('width', `${stats.ram_percent}%`);
                $('#stats-storage p').eq(0).html(`${stats.disk_root_used} of ${stats.disk_root_total}`);
                $('#stats-storage .progress-bar').eq(0).css('width', `${stats.disk_root_percent}%`);
                $('#stats-storage p').eq(1).html(`${stats.disk_user_used} of ${stats.disk_user_total}`);
                $('#stats-storage .progress-bar').eq(1).css('width', `${stats.disk_user_percent}%`);
                console.log(data.server_stats);
            } else if (data.stats) {
                let seen_tags = {};
                let row_for_group = {};
                let tags_for_group = {};
                let table = $('<div>');
                let tbody = null;
                for (let tag in data.stats) {
                    let name = data.stats[tag].name;
                    const { background: bg_color, color: fg_color } = getUserColors(tag);
                    let group = data.stats[tag].group;
                    let shorthand = name.split(/[\s@\.]/).map((x) => x[0]).join('');
                    if (!(group in row_for_group)) {
                        if (Object.keys(row_for_group).length === 0) {
                            table = $(`<table class='table table-sm'>`);
                            let thead = $(`<thead>`).appendTo(table);
                            let row = $(`<tr>`).appendTo(thead);
                            row.append($(`<th>`).text('Group'));
                            row.append($(`<th>`).text('Count'));
                            row.append($(`<th>`).text('Users'));
                            tbody = $(`<tbody>`).appendTo(table);
                        }
                        let row = $(`<tr>`);
                        row_for_group[group] = row;
                        tags_for_group[group] = 0;
                        row.append($(`<td>`).text(group));
                        row.append($(`<td>`).text('0'));
                        row.append($(`<td>`));
                        tbody.append(row);
                    }
                    tags_for_group[group] += 1;
                    $(row_for_group[group]).find('td').eq(1).text(`${tags_for_group[group]}`);
                    let cell = $(row_for_group[group]).find('td').eq(2);
                    cell.html(`${cell.html()} <span class='badge' style='background-color: ${bg_color}; color: ${fg_color};'>${shorthand}</span>`);
                    seen_tags[tag] = true;
                    let row = $(`#tr_hs_code_${tag}`);
                    let perc = parseFloat(data.stats[tag].stats['CPUPerc']) / 100.0;
                    row.css('background-color', `rgba(255, 200, 0, ${perc})`);
                    row.find('.td_cpu').html(wrapLettersInSpan(data.stats[tag].stats['CPUPerc']));
                    row.find('.td_ram').html(wrapLettersInSpan((data.stats[tag].stats['MemUsage'] ?? '').split('/')[0].trim().replace('iB', '')));
                    row.find('.td_net').html(wrapLettersInSpan(data.stats[tag].stats['NetIO'].replace(/B/g, '')));
                    row.find('.td_disk').html(wrapLettersInSpan(data.stats[tag].stats['BlockIO'].replace(/B/g, '')));
                    row.find('.td_pid').html(wrapLettersInSpan(data.stats[tag].stats['PIDs']));
                }
                $('#active_users_here').empty().append(table);
                for (let row of $('#table_admin_workspaces tr')) {
                    let tag = ($(row).attr('id') ?? '').replace('tr_hs_code_', '');
                    if (!(tag in seen_tags)) {
                        $(row).css('background-color', `unset`);
                        // $(row).find('.td_ip').html('&ndash;')
                        $(row).find('.td_cpu').html('&ndash;')
                        $(row).find('.td_ram').html('&ndash;')
                        $(row).find('.td_net').html('&ndash;')
                        $(row).find('.td_disk').html('&ndash;')
                        $(row).find('.td_pid').html('&ndash;')
                    }
                }
            }
            if (data.action === 'login_codes') {
                // console.log(data.lines);
                if (data.lines.length === 0) {
                    $('#login_codes_here').hide();
                } else {
                    let tbody = $('#login_codes_here').find('tbody');
                    tbody.empty();
                    for (let line of data.lines) {
                        let row = $('<tr>').appendTo(tbody);
                        row.append($('<td>').text(line.email));
                        row.append($('<td>').text(line.code));
                    }
                    $('#login_codes_here').show();
                }
            }
        }
    }

    function establish_websocket_connection() {
        var ws_uri = 'ws://' + location.host + '/ws';
        if (location.port !== '8025')
            ws_uri = 'wss://' + location.host + '/ws';
        ws = new WebSocket(ws_uri);
        setup_ws(ws);
    }

    window.addEventListener('load', function () {
        establish_websocket_connection();
        $('.bu-open-workspace-as-admin').on('click', function (e) {
            let button = $(e.target).closest('button');
            let email = button.data('email');
            console.log(`Opening workspace for ${email}`);
            button.prop('disabled', true);
            button.find('.bi').addClass('bi-spin');
            api_call('/api/start_server_as_admin', { email: email }, function (data) {
                check_server_tag_update(data.watch_tag);
                check_server_online(data.watch_tag, true);
            });
        });
        $('.bu-impersonate').on('click', function (e) {
            let button = $(e.target).closest('button');
            let email = button.data('email');
            button.prop('disabled', true);
            button.find('.bi').addClass('bi-spin');
            api_call('/api/impersonate', { email: email }, function (data) {
                location.href = '/';
            });
        });
    });
</script>