<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hackschule Workspace</title>
    <link href="/include/bootstrap.min.css" rel="stylesheet">
    <link href="/include/bower_components/fork-awesome/css/fork-awesome.min.css" rel="stylesheet">

    <link href="/include/fonts.css?#{CACHE_BUSTER}" rel="stylesheet">
    <link href="/include/default.css?#{CACHE_BUSTER}" rel="stylesheet">

    <script src="/include/code.js?#{CACHE_BUSTER}"></script>
    <script src="/include/bower_components/moment/min/moment-with-locales.min.js"></script>
    <script src="/include/bootstrap.bundle.min.js"></script>
    <script src="/include/bower_components/jquery/dist/jquery.min.js"></script>
</head>

<script>
function showTemplateModal(title, text, confirm_label, confirm_class,
    cancel_label, cancel_class, confirm_callback) {
    $('#__template_modal .modal-title').html(title);
    $('#__template_modal .modal-body').html(text);
    let bu_confirm = $('<button>').addClass('btn ' + confirm_class).html(confirm_label);
    $('#__template_modal .modal-footer').empty().append(bu_confirm);
    if (cancel_label !== null) {
        let bu_cancel = $('<button>').addClass('btn ' + cancel_class).html(cancel_label).attr('data-dismiss', 'modal');
        $('#__template_modal .modal-footer').append(bu_cancel);
        bu_cancel.on('click', function(e) {
            $('#__template_modal').modal('hide');
        });
    }
    bu_confirm.click(function(e) {
        confirm_callback();
        $('#__template_modal').modal('hide');
    });
    $('#__template_modal').modal('show');
}

var server_tag = "#{(@session_user || {})[:server_tag]}";
function check_server_online() {
    fetch(`/${server_tag}/`) // replace with your actual API endpoint
    .then(response => {
        if (response.status === 200) {
            console.log('Server is online');
            window.location.href = `/${server_tag}/`;
    } else {
            console.log('Server is offline');
            setTimeout(function() { check_server_online(); }, 500);
        }
    })
    .catch(error => {
        console.log('Error:', error);
    });
}

function check_server_tag_update(server_tag) {
    let stored_server_tag = localStorage.getItem('server_tag');
    if (server_tag !== stored_server_tag) {
        console.log('Server tag has changed, purging indexed DB...');
        (async () => {
            const dbs = await window.indexedDB.databases();
            dbs.forEach(db => { window.indexedDB.deleteDatabase(db.name) });
        })();
        localStorage.setItem('server_tag', server_tag);
    }
}

window.addEventListener('load', function() {
    // check if the server tag has changed
    if ('#{user_logged_in?}' === 'true') {
        let server_tag = '#{(@session_user || {})[:server_tag]}';
        check_server_tag_update(server_tag);
    }

    $('#bu_launch').on('click', function(e) {
        $('#bu_launch').prop('disabled', true);
        $('#bu_launch .fa').addClass('fa-spin');
        api_call('/api/start_server', {}, function(data) {
            check_server_tag_update(data.server_tag);
            check_server_online();
        });
    });
    $('#bu_reset').on('click', function(e) {
        showTemplateModal('Workspace zurücksetzen', 'Bist du sicher, dass du deinen Workspace zurücksetzen möchtest? Alle Dateien und deine installierten Erweiterungen werden gelöscht.',
        "<i class='fa fa-trash'></i>&nbsp;&nbsp;Zurücksetzen", 'btn-danger', "<i class='fa fa-times'></i>&nbsp;&nbsp;Abbruch", 'btn-secondary', function() {
            api_call('/api/reset_server', {}, function(data) {
                // we need to reload the website to receive the updated server_tag and server_sid
                window.location.reload();
            });
        });
    });
    $('#bu_share').on('click', function(e) {
        showTemplateModal('Workspace teilen', 'Wenn du deinen Workspace teilst, erhältst du einen Link, mit dem man ohne Anmeldung auf deinen Workspace zugreifen kann. Möchtest du deinen Workspace teilen?',
        "<i class='fa fa-send'></i>&nbsp;&nbsp;Workspace teilen", 'btn-primary', "<i class='fa fa-times'></i>&nbsp;&nbsp;Abbruch", 'btn-secondary', function() {
            api_call('/api/share_server', {}, function(data) {
                if (data.success) {
                    $('#ti_share_link').val("#{WEB_ROOT}/" + data.share_tag);
                    $('#div_share_link').slideDown();
                }
            });
        });
    });
    $('#bu_stop_share').on('click', function(e) {
        showTemplateModal('Teilen beenden', 'Bist du sicher, dass du die Teilung aufheben möchtest? Der Link kann dann nicht mehr für den Zugriff auf deinen Workspace verwendet werden.',
        "<i class='fa fa-trash'></i>&nbsp;&nbsp;Teilen beenden", 'btn-danger', "<i class='fa fa-times'></i>&nbsp;&nbsp;Abbruch", 'btn-secondary', function() {
            api_call('/api/unshare_server', {}, function(data) {
                if (data.success) {
                    console.log(data.share_tag);
                }
            });
        });
    });

    $('#bu_settings').on('click', function(e) {
        if ($('#div_settings').is(':visible'))
            $('#div_settings').slideUp();
        else
            $('#div_settings').slideDown();
    });
});
</script>

<body>
    <div class="modal" id="__template_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style='z-index: 200000;'>
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" >
                    </h5>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <div class="header">
        <div class="container">
            <div class="title"><a href='/'>Hackschule Workspace</a></div>
        </div>
    </div>
    <div class="menu">
        <div class="container">
            <div style='text-align: center; width: 100%;'>
                <a style='#{@session_user.nil? ? '' : 'display: none;'}' class="btn btn-success #{path == '/login.html' ? 'active' : ''}" href="/login"><i class='fa fa-sign-in'></i>&nbsp;Anmelden</a>
                <button  style='#{@session_user.nil? ? 'display: none;' : ''}' id='bu_launch' class="btn btn-success"><i class='fa fa-code'></i>&nbsp;Workspace öffnen</button>
                <button  style='#{@session_user.nil? ? 'display: none;' : ''}' id='bu_settings' class="btn btn-outline-secondary"><i class='fa fa-cog'></i></button>
            </div>
            <div id='div_settings' style='display: none; text-align: center; width: 100%; border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px;'>
                <div>
                    <button style='#{(@session_user || {})[:share_tag].nil? ? '' : 'display: none;'}'id='bu_share' class="btn btn-primary"><i class='fa fa-send'></i>&nbsp;&nbsp;Teilen</button>
                    <button style='#{(@session_user || {})[:share_tag].nil? ? 'display: none;' : ''}' id='bu_stop_share' class="btn btn-primary"><i class='fa fa-send'></i>&nbsp;&nbsp;Teilen beenden</button>
                    <button id='bu_reset' class="btn btn-danger"><i class='fa fa-trash'></i>&nbsp;&nbsp;Zurücksetzen</button>
                    <a style='#{!@session_user.nil? ? '' : 'display: none;'}' class="btn btn-outline-secondary" href="/logout"><i class='fa fa-sign-out'></i>&nbsp;Abmelden</a>
                </div>
                <div id='div_share_link' class="input-group mb-3 mt-2" style="#{(@session_user || {})[:share_tag] ? '' : 'display: none;'}">
                    <span class="input-group-text">Freigabelink:</span>
                    <input type="text" id='ti_share_link' class="form-control" readonly value="#{WEB_ROOT}/#{(@session_user || {})[:share_tag]}">
                    <button id='bu_copy_share_link' class="btn btn-primary"><i class="fa fa-copy"></i>&nbsp;&nbsp;Kopieren</button>
                </div>
            </div>
        </div>
    </div>
    #{CONTENT}

    <!-- <footer>
        <a href='/impressum'>Impressum</a>
        <span style="display: inline-block; width: 1em;"></span>
        <a href='/dse'>Datenschutzerklärung</a>
        <span style="display: inline-block; width: 1em;"></span>
        <a href='/credits'>Credits</a>
    </footer> -->
    <div class='please-reload' style='display: none;'>
        Die Verbindung zum Server wurde unterbrochen. Bitte lade die Seite neu.
    </div>
</body>
</html>
