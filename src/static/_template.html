<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hackschule Workspace</title>
    <link href="/include/bootstrap.min.css" rel="stylesheet">
    <link href="/include/bower_components/fork-awesome/css/fork-awesome.min.css" rel="stylesheet">

    <link href="/include/fonts.css?#{CACHE_BUSTER}" rel="stylesheet">
    <link href="/include/default.css?#{CACHE_BUSTER}" rel="stylesheet">

    <script src="/include/code.js?#{CACHE_BUSTER}"></script>
    <script src="/include/bower_components/moment/min/moment-with-locales.min.js"></script>
    <script src="/include/bootstrap.bundle.min.js"></script>
    <script src="/include/clipboard.min.js"></script>
    <script src="/include/bower_components/jquery/dist/jquery.min.js"></script>
</head>

<style>
/* #{Rouge::Theme.find('base16.light').render(scope: 'pre')} */
#{Rouge::Theme.find('gruvbox').render(scope: 'pre')}
pre table td {
    padding: 0;
    border-radius: 0;
}
.rouge-gutter {
    /* padding-right: 1em; */
    opacity: 0.5;
    text-align: right;
}
</style>

<script>

function install_clipboard_handler(selector) {
    window.clipboard = new ClipboardJS(selector);
    window.clipboard.on('success', function(e) {
        let check = $("<i class='fa fa-check btn-success btn-clipboard-check' style='position: absolute; left: 0.8em; top: 0.6em;'/>");
        $(e.trigger).closest('.btn').find('.fa-clipboard').css('visibility', 'hidden');
        $(e.trigger).append(check);
        (function(check) {
            setTimeout(function() {
                check.fadeOut(400, function() {
                    $(e.trigger).closest('.btn').find('.fa-clipboard').css('visibility', 'visible');
                    check.remove();
                });
            }, 1000);
        })(check);
    });
}

function showTemplateModal(title, text, confirm_label, confirm_class,
    cancel_label, cancel_class, confirm_callback) {
    $('#__template_modal .modal-title').html(title);
    $('#__template_modal .modal-body').html(text);
    let bu_confirm = $('<button>').addClass('btn ' + confirm_class).html(confirm_label);
    $('#__template_modal .modal-footer').empty().append(bu_confirm);
    if (cancel_label !== null) {
        let bu_cancel = $('<button>').addClass('btn ' + cancel_class).html(cancel_label).attr('data-dismiss', 'modal');
        $('#__template_modal .modal-footer').append(bu_cancel);
        bu_cancel.on('click', function(e) {
            $('#__template_modal').modal('hide');
        });
    }
    bu_confirm.click(function(e) {
        confirm_callback();
        $('#__template_modal').modal('hide');
    });
    $('#__template_modal').modal('show');
}

var server_tag = "#{(@session_user || {})[:server_tag]}";
function check_server_online(server_tag) {
    fetch(`/${server_tag}/`)
    .then(response => {
        if (response.status === 200) {
            console.log('Server is online');
            $('#bu_launch .fa').removeClass('fa-spin');
            $('#bu_launch').prop('disabled', false);
            $('.bu-open-workspace-as-admin .fa').removeClass('fa-spin');
            $('.bu-open-workspace-as-admin').prop('disabled', false);
            window.open(`/${server_tag}/`, '_blank');
        } else {
            console.log('Server is offline');
            setTimeout(function() { check_server_online(server_tag); }, 500);
        }
    })
    .catch(error => {
        console.log('Error:', error);
    });
}

function check_server_tag_update(server_tag) {
    let stored_server_tag = localStorage.getItem('server_tag');
    if (server_tag !== stored_server_tag) {
        console.log('Server tag has changed, purging indexed DB...');
        (async () => {
            const dbs = await window.indexedDB.databases();
            dbs.forEach(db => { window.indexedDB.deleteDatabase(db.name) });
        })();
        localStorage.setItem('server_tag', server_tag);
    }
}

window.addEventListener('load', function() {
    install_clipboard_handler('.btn-clipboard');
    // check if the server tag has changed
    if ('#{user_logged_in?}' === 'true') {
        let server_tag = '#{(@session_user || {})[:server_tag]}';
        check_server_tag_update(server_tag);
    }

    $('#bu_launch').on('click', function(e) {
        $('#bu_launch').prop('disabled', true);
        $('#bu_launch .fa').addClass('fa-spin');
        api_call('/api/start_server', {}, function(data) {
            check_server_tag_update(data.server_tag);
            check_server_online(data.server_tag);
        });
    });
    $('#bu_reset').on('click', function(e) {
        showTemplateModal('Workspace zurücksetzen', 'Bist du sicher, dass du deinen Workspace zurücksetzen möchtest? Alle Dateien und deine installierten Erweiterungen werden gelöscht.',
        "<i class='fa fa-trash'></i>&nbsp;&nbsp;Zurücksetzen", 'btn-danger', "<i class='fa fa-times'></i>&nbsp;&nbsp;Abbruch", 'btn-secondary', function() {
            api_call('/api/reset_server', {}, function(data) {
                // we need to reload the website to receive the updated server_tag and server_sid
                window.location.reload();
            });
        });
    });
    $('#bu_share').on('click', function(e) {
        showTemplateModal('Workspace teilen', 'Wenn du deinen Workspace teilst, erhältst du einen Link, mit dem man ohne Anmeldung auf deinen Workspace zugreifen kann. Möchtest du deinen Workspace teilen?',
        "<i class='fa fa-send'></i>&nbsp;&nbsp;Workspace teilen", 'btn-primary', "<i class='fa fa-times'></i>&nbsp;&nbsp;Abbruch", 'btn-secondary', function() {
            api_call('/api/share_server', {}, function(data) {
                if (data.success) {
                    $('#ti_share_link').val("#{WEB_ROOT}/share/" + data.share_tag);
                    $('#bu_copy_share_link').attr('data-clipboard-text', "#{WEB_ROOT}/share/" + data.share_tag);
                    $('#div_share_link').slideDown();
                    $('#bu_share').hide();
                    $('#bu_stop_share').show();
                }
            });
        });
    });
    $('#bu_stop_share').on('click', function(e) {
        showTemplateModal('Teilen beenden', 'Bist du sicher, dass du die Teilung aufheben möchtest? Der Link kann dann nicht mehr für den Zugriff auf deinen Workspace verwendet werden.',
        "<i class='fa fa-trash'></i>&nbsp;&nbsp;Teilen beenden", 'btn-primary', "<i class='fa fa-times'></i>&nbsp;&nbsp;Abbruch", 'btn-secondary', function() {
            api_call('/api/unshare_server', {}, function(data) {
                if (data.success) {
                    $('#ti_share_link').val('');
                    $('#div_share_link').slideUp();
                    $('#bu_share').show();
                    $('#bu_stop_share').hide();
                }
            });
        });
    });

    $('#bu_settings').on('click', function(e) {
        if ($('#div_settings').is(':visible')) {
            $('#div_settings').slideUp();
            $('#bu_settings .fa-chevron-down').removeClass('rot180');
        } else {
            $('#div_settings').slideDown();
            $('#bu_settings .fa-chevron-down').addClass('rot180');
        }
    });
});
</script>

<body>
    <div class="modal" id="__template_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style='z-index: 200000;'>
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" >
                    </h5>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <div class="header">
        <div class="container">
            <div class="title"><a href='/'>Hackschule Workspace</a></div>
        </div>
    </div>
    <div class="menu">
        <div class="container">
            <div style='text-align: center; width: 100%;'>
                <a style='#{@session_user.nil? ? '' : 'display: none;'}' class="btn btn-success #{path == '/login.html' ? 'active' : ''}" href="/login"><i class='fa fa-sign-in'></i>&nbsp;&nbsp;Anmelden</a>
                <button style='#{(@session_user.nil? || (!@session_user[:show_workspace])) ? 'display: none;' : ''}' id='bu_launch' class="btn btn-success"><i class='fa fa-code'></i>&nbsp;&nbsp;Workspace öffnen</button>
                <a style='#{(@session_user.nil? || (!@session_user[:show_phpmyadmin])) ? 'display: none;' : ''}' href="/phpmyadmin/" class="btn btn-success" target="_blank"><i class='fa fa-database'></i>&nbsp;&nbsp;phpMyAdmin</a>
                <a style='#{(@session_user.nil? || (!@session_user[:show_tic80])) ? 'display: none;' : ''}' href="/tic80/" class="btn btn-success" target="_blank"><i class='fa fa-keyboard-o'></i>&nbsp;&nbsp;TIC-80</a>
                <a href='/profil' style='#{@session_user.nil? ? 'display: none;' : ''}' class="btn btn-secondary"><i class='fa fa-wrench'></i>&nbsp;&nbsp;Profil</a>
                <a href='/admin' style='#{admin_logged_in? ? '' : 'display: none;'}' class="btn btn-warning"><i class='fa fa-wrench'></i>&nbsp;&nbsp;Administration</a>
                <!-- <button style='#{@session_user.nil? ? 'display: none;' : ''}' id='bu_settings' class="btn btn-outline-secondary"><i class='fa fa-chevron-down rot'></i></button> -->
            </div>
            <!-- <div id='div_settings' style='display: none; text-align: center; width: 100%; border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px;'>
                <div style="margin-top: -6px;">
                    <button style='margin-top: 4px; #{(@session_user || {})[:share_tag].nil? ? '' : 'display: none;'}'id='bu_share' class="btn btn-primary"><i class='fa fa-send'></i>&nbsp;&nbsp;Teilen</button>
                    <button style='margin-top: 4px; #{(@session_user || {})[:share_tag].nil? ? 'display: none;' : ''}' id='bu_stop_share' class="btn btn-primary"><i class='fa fa-trash'></i>&nbsp;&nbsp;Teilen beenden</button>
                    <button style='margin-top: 4px; ' id='bu_reset' class="btn btn-danger"><i class='fa fa-trash'></i>&nbsp;&nbsp;Zurücksetzen</button>
                    <a style='margin-top: 4px; #{!@session_user.nil? ? '' : 'display: none;'}' class="btn btn-outline-secondary" href="/logout"><i class='fa fa-sign-out'></i>&nbsp;Abmelden</a>
                </div>
                <div style="display: table; margin-left: auto; margin-right: auto;">
                    <div id='div_share_link' class="input-group mt-2" style="#{(@session_user || {})[:share_tag] ? '' : 'display: none;'}">
                        <span class="input-group-text">Freigabelink:</span>
                        <input type="text" id='ti_share_link' style='max-width: 42em;' class="form-control" readonly value="#{WEB_ROOT}/share/#{(@session_user || {})[:share_tag]}">
                        <button id='bu_copy_share_link' class='btn btn-secondary btn-clipboard' data-clipboard-action='copy' title='Eintrag in die Zwischenablage kopieren' data-clipboard-text='#{WEB_ROOT}/share/#{(@session_user || {})[:share_tag]}'><i class='fa fa-clipboard'></i></button>
                    </div>
                </div>
            </div> -->
        </div>
    </div>
    #{CONTENT}

    <!-- <footer>
        <a href='/impressum'>Impressum</a>
        <span style="display: inline-block; width: 1em;"></span>
        <a href='/dse'>Datenschutzerklärung</a>
        <span style="display: inline-block; width: 1em;"></span>
        <a href='/credits'>Credits</a>
    </footer> -->
    <div class='please-reload' style='display: none;'>
        Die Verbindung zum Server wurde unterbrochen. Bitte lade die Seite neu.
    </div>
</body>
</html>
