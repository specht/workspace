<link rel="stylesheet" href="/include/xterm/xterm.css" />

<style>
  :root {
    --topbar-h: 56px;
  }

  html, body {
    height: 100%;
    margin: 0;
  }

  .page {
    height: 100vh;
    display: grid;
    grid-template-rows: var(--topbar-h) 1fr;
  }

  .topbar {
    height: var(--topbar-h);
    display: flex;
    align-items: center;
    padding: 0 16px;
    border-bottom: 1px solid #ddd;
    background: #fff;
    z-index: 10;
  }

  .main {
    min-height: 0;
    display: grid;
    grid-template-columns: 0.8fr 1.2fr 1.2fr;
    gap: 12px;
    padding: 12px;
  }

  .problem {
    min-height: 0;
    overflow: auto;
    padding-right: 8px;

    h1, h2, h3, h4 {
      margin: 0.5em 0;
    }

    table {
        margin-bottom: 1em;
    }
    td {
        vertical-align: top;
        padding-right: 0.25em;
    }
  }

  .ide-wrap {
    min-height: 0;
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 8px;
  }

  .pane {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0.1em 0.1em 0.5em rgba(0, 0, 0, 0.2);
    background: #080808;
    padding: 1em;
    min-height: 0;
  }

  .ide {
    --left: 50%;
    --h: 100%;

    min-height: 0;
    height: var(--h);

    display: grid;
    grid-template-columns: var(--left) 10px 1fr;
    gap: 0;
    user-select: none;
  }

  .pane-body,
  #editor,
  #terminal {
    height: 100%;
    min-height: 0;
  }

  .gutter {
    cursor: col-resize;
    border-radius: 999px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.08);
  }
  .gutter:hover {
    background: rgba(255, 255, 255, 0.16);
  }

  .resize-row {
    height: 12px;
    cursor: row-resize;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.06);
  }
  .resize-row:hover {
    background: rgba(0, 0, 0, 0.12);
  }

  .topbar {
    a {
      text-decoration: none;
      color: #333;
    }
    a:hover {
        text-decoration: underline;
    }
  }
</style>

<div class="page">
  <div class="topbar">
    <a href="/">Workspace</a>
    <span style="margin: 0 0.5em;">/</span>
    <a href="/codebites">Code Bites</a>
    <span style="margin: 0 0.5em;">/</span>
    <a href="/codebites/basics">Basics</a>
  </div>

  <div class="main">
    <div class="problem">
    </div>

    <div class="ide-wrap" style="grid-column: 2 / span 2;">
      <div id="ide" class="ide">
        <div class="pane">
          <div class="pane-body" id="editor"></div>
        </div>

        <div id="gutter" class="gutter" title="Drag to resize width"></div>

        <div class="pane">
          <div class="pane-body" id="terminal"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/include/monaco/package/min/vs/loader.js"></script>
<script>
  var language = "ruby";

  function reloadPage() {
    let slug = window.location.pathname.split("/codebites")[1];
    let task = (slug.split("/")[1] ?? '').trim();
    let sha1 = (slug.split("/")[2] ?? '').trim();
    if (task === '') task = null;
    if (sha1 === '') sha1 = null;
    console.log(`Task: ${task}, SHA1: ${sha1}`);
    if (task === null) {
      api_call('/api/codebites_get_tasks', {}, function(data) {
        if (data.success) {
          console.log(data);
          let div = $('<div>');
          for (let section of data.sections) {
            let title_and_icon = $('<div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">');
            title_and_icon.append(`<h2>${section.title}</h2>`);
            title_and_icon.append(`<img src="${section.icon}" style="width: 32px; height: 32px;">`);
            div.append(title_and_icon);
            div.append(`<p>${section.description}</p>`);
            for (let entry of section.entries) {
              let heading = data.tasks[entry] ? data.tasks[entry].heading : entry;
              div.append(`<a href="/codebites/${entry}" class="btn w-100">${heading}</a>`);
            }
          }
          $('.problem').html(div);
        }
      });
    } else {
      api_call('/api/get_codebite', { task: task }, function(data) {
        if (data.success) {
          console.log(data);
          $('.problem').html(data.result.problem);
          window.setCode(data.result.starter.ruby);
          // feedBytes(data.output);
        }
      });
    }
  }

  (function () {
    const ideEl = document.getElementById("ide");
    const gutterEl = document.getElementById("gutter");

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    let editor = null;
    let term = null;
    let fitAddon = null;

    function relayout() {
      if (editor) editor.layout();
      if (fitAddon) fitAddon.fit();
    }

    (function setupWidthDrag() {
      let dragging = false;

      function onMove(e) {
        if (!dragging) return;

        const rect = ideEl.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = (x / rect.width) * 100;

        ideEl.style.setProperty("--left", clamp(pct, 20, 80) + "%");
        relayout();
      }

      function stop() {
        if (!dragging) return;
        dragging = false;
        document.body.style.cursor = "";
        document.body.style.userSelect = "";
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", stop);
        relayout();
      }

      gutterEl.addEventListener("mousedown", (e) => {
        e.preventDefault();
        dragging = true;
        document.body.style.cursor = "col-resize";
        document.body.style.userSelect = "none";
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", stop);
      });
    })();

    window.addEventListener("resize", () => relayout());

    window.require.config({
      paths: {
        vs: "/include/monaco/package/min/vs",
        xterm: "/include/xterm/xterm",
        "xterm-addon-fit": "/include/xterm/addon-fit"
      }
    });

    window.require(["vs/editor/editor.main", "xterm", "xterm-addon-fit"], function (_monacoMain, xterm, fitMod) {
      editor = monaco.editor.create(document.getElementById("editor"), {
        // value: "def two_sum(nums, target)\n    # FÃ¼ge deinen Code hier ein\nend\n",
        language: language,
        theme: "vs-dark",
        minimap: { enabled: false },
        tabSize: 4,
        // readOnly: true,
        insertSpaces: true,
        automaticLayout: false,
        formatOnPaste: true,
        formatOnType: true,
        autoIndent: "full",
        fontFamily: '"0xProto", monospace',
        fontSize: 15,
        fontLigatures: true
      });

      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function () {
        console.log(editor.getValue());
      });

      window.getCode = () => editor.getValue();
      window.setCode = (code) => editor.setValue(code);

      term = new xterm.Terminal({
        convertEol: true,
        disableStdin: true,
        cursorBlink: false,
        fontFamily: '"0xProto", monospace',
        fontSize: 15
      });

      fitAddon = new fitMod.FitAddon();
      term.loadAddon(fitAddon);

      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      window.feedBytes = (bytes) => term.write(bytes);

      // term.write("Hello \x1b[1;32mANSI\x1b[0m terminal\r\n");

      relayout();
      reloadPage();
    });
  })();
</script>