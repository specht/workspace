<link rel="stylesheet" href="/include/xterm/xterm.css" />

<style>
  :root {
    --topbar-h: 56px;
    --left: 50%;
  }

  html,
  body {
    height: 100%;
    margin: 0;
  }

  .page {
    height: 100vh;
    display: grid;
    grid-template-rows: var(--topbar-h) 1fr;
  }

  .topbar {
    height: var(--topbar-h);
    padding: 0 16px;
    border-bottom: 1px solid #ddd;
    background: #fff;
    z-index: 10;

    display: grid;
    grid-template-columns: 0.8fr 1.2fr 1.2fr;
    gap: 12px;
    align-items: center;
  }

  .topbar-left {
    grid-column: 1;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar-ide {
    grid-column: 2 / span 2;

    display: grid;
    grid-template-columns: var(--left) 10px 1fr;
    align-items: center;
  }

  .topbar-editor-left {
    grid-column: 1;
    justify-self: start;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar-terminal-right {
    grid-column: 3;
    justify-self: end;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar a {
    text-decoration: none;
    color: #333;
  }

  .topbar a:hover {
    text-decoration: underline;
  }

  .main {
    min-height: 0;
    display: grid;
    grid-template-columns: 0.8fr 1.2fr 1.2fr;
    gap: 12px;
    padding: 12px;
  }

  .problem {
    min-height: 0;
    overflow: auto;
    padding-right: 8px;
  }

  .problem h1,
  .problem h2,
  .problem h3,
  .problem h4 {
    margin: 0.5em 0;
  }

  .problem table {
    margin-bottom: 1em;
  }

  .problem td {
    vertical-align: top;
    padding-right: 0.25em;
  }

  .ide-wrap {
    min-height: 0;
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 8px;
  }

  .pane {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0.1em 0.1em 0.5em rgba(0, 0, 0, 0.2);
    background: #080808;
    padding: 1em;
    min-height: 0;
  }

  .ide {
    --left: 50%;
    --h: 100%;

    min-height: 0;
    height: var(--h);

    display: grid;
    grid-template-columns: var(--left) 10px 1fr;
    gap: 0;
    user-select: none;
  }

  .pane-body,
  #editor,
  #terminal {
    height: 100%;
    min-height: 0;
  }

  .gutter {
    cursor: col-resize;
    border-radius: 999px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.08);
  }

  .gutter:hover {
    background: rgba(255, 255, 255, 0.16);
  }

  .resize-row {
    height: 12px;
    cursor: row-resize;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.06);
  }

  .resize-row:hover {
    background: rgba(0, 0, 0, 0.12);
  }
</style>

<div class="page">
  <div class="topbar">

    <div class="topbar-left">
      <a href="/">Workspace</a>
      <span>/</span>
      <a href="/codebites">Code Bites</a>
      <span>/</span>
      <a href="/codebites/basics">Basics</a>
    </div>

    <div class="topbar-ide">

      <div class="topbar-editor-left">
        <button class="btn btn-light" disabled>Python</button>
        <button class="btn btn-light" disabled>Ruby</button>
        <button class="btn btn-light" disabled>JavaScript</button>
      </div>

      <div class="topbar-terminal-right">
        <button class="btn btn-success"><i class='bi bi-play-fill'></i>Ausf√ºhren</button>
      </div>

    </div>

  </div>
  <div class="main">
    <div class="problem"></div>

    <div class="ide-wrap" style="grid-column: 2 / span 2;">
      <div id="ide" class="ide">
        <div class="pane">
          <div class="pane-body" id="editor"></div>
        </div>

        <div id="gutter" class="gutter" title="Drag to resize width"></div>

        <div class="pane">
          <div class="pane-body" id="terminal"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/include/monaco/package/min/vs/loader.js"></script>
<script>
  var language = "ruby";

  function reloadPage() {
    let slug = window.location.pathname.split("/codebites")[1];
    let task = (slug.split("/")[1] ?? "").trim();
    let sha1 = (slug.split("/")[2] ?? "").trim();
    if (task === "") task = null;
    if (sha1 === "") sha1 = null;

    console.log(`Task: ${task}, SHA1: ${sha1}`);
    if (task === null) {
      api_call("/api/codebites_get_tasks", {}, function (data) {
        if (data.success) {
          let div = $("<div>");
          for (let section of data.sections) {
            let title_and_icon = $(
              '<div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">'
            );
            title_and_icon.append(`<h2>${section.title}</h2>`);
            title_and_icon.append(
              `<img src="${section.icon}" style="width: 32px; height: 32px;">`
            );
            div.append(title_and_icon);
            div.append(`<p>${section.description}</p>`);
            for (let entry of section.entries) {
              let heading = data.tasks[entry] ? data.tasks[entry].heading : entry;
              div.append(
                `<a href="/codebites/${entry}" class="btn w-100">${heading}</a>`
              );
            }
          }
          $(".problem").html(div);
        }
      });
    } else {
      api_call("/api/get_codebite", { task: task }, function (data) {
        if (data.success) {
          $(".problem").html(data.result.problem);
          window.setCode(data.result.starter.ruby);
        }
      });
    }
  }

  (function () {
    const ideEl = document.getElementById("ide");
    const gutterEl = document.getElementById("gutter");

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    let editor = null;
    let term = null;
    let fitAddon = null;

    function relayout() {
      if (editor) editor.layout();
      if (fitAddon) fitAddon.fit();
    }

    (function setupWidthDrag() {
      let dragging = false;

      function onMove(e) {
        if (!dragging) return;

        const rect = ideEl.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = (x / rect.width) * 100;

        ideEl.style.setProperty("--left", clamp(pct, 20, 80) + "%");
        relayout();
      }

      function stop() {
        if (!dragging) return;
        dragging = false;
        document.body.style.cursor = "";
        document.body.style.userSelect = "";
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", stop);
        relayout();
      }

      gutterEl.addEventListener("mousedown", (e) => {
        e.preventDefault();
        dragging = true;
        document.body.style.cursor = "col-resize";
        document.body.style.userSelect = "none";
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", stop);
      });
    })();

    window.addEventListener("resize", () => relayout());

    window.require.config({
      paths: {
        vs: "/include/monaco/package/min/vs",
        xterm: "/include/xterm/xterm",
        "xterm-addon-fit": "/include/xterm/addon-fit",
      },
    });

    window.require(["vs/editor/editor.main", "xterm", "xterm-addon-fit"], function (
      _monacoMain,
      xterm,
      fitMod
    ) {
      editor = monaco.editor.create(document.getElementById("editor"), {
        language: language,
        theme: "vs-dark",
        minimap: { enabled: false },
        tabSize: 4,
        insertSpaces: true,
        automaticLayout: false,
        formatOnPaste: true,
        formatOnType: true,
        autoIndent: "full",
        fontFamily: '"0xProto", monospace',
        fontSize: 15,
        fontLigatures: true,
      });

      window.getCode = () => editor.getValue();
      window.setCode = (code) => editor.setValue(code);

      term = new xterm.Terminal({
        convertEol: true,
        disableStdin: true,
        cursorBlink: false,
        fontFamily: '"0xProto", monospace',
        fontSize: 15,
      });

      fitAddon = new fitMod.FitAddon();
      term.loadAddon(fitAddon);

      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      window.feedBytes = (bytes) => term.write(bytes);

      document.getElementById("runBtn")?.addEventListener("click", () => {
        console.log(editor.getValue());
      });

      document.getElementById("resetBtn")?.addEventListener("click", () => {
        // editor.setValue(...);
      });

      relayout();
      reloadPage();
    });
  })();
</script>