<link rel="stylesheet" href="/include/xterm/xterm.css" />

<style>
  :root {
    --topbar-h: 56px;
    --left: 50%;
  }

  html,
  body {
    height: 100%;
    margin: 0;
  }

  .page {
    height: 100vh;
    display: grid;
    grid-template-rows: var(--topbar-h) 1fr;
  }

  .topbar {
    height: var(--topbar-h);
    padding: 0 16px;
    border-bottom: 1px solid #ddd;
    background: #fff;
    z-index: 10;

    display: grid;
    grid-template-columns: 0.8fr 1.2fr 1.2fr;
    gap: 12px;
    align-items: center;
  }

  .topbar-left {
    grid-column: 1;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar-ide {
    grid-column: 2 / span 2;

    display: grid;
    grid-template-columns: var(--left) 10px 1fr;
    align-items: center;
  }

  .topbar-editor-left {
    grid-column: 1;
    justify-self: start;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar-terminal-right {
    grid-column: 3;
    justify-self: end;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar a {
    text-decoration: none;
    color: #333;
  }

  .topbar a:hover {
    text-decoration: underline;
  }

  .main {
    min-height: 0;
    display: grid;
    grid-template-columns: 0.8fr 1.2fr 1.2fr;
    gap: 12px;
    padding: 12px;
  }

  .problem {
    min-height: 0;
    overflow: auto;
    padding-right: 8px;
  }

  .problem h1,
  .problem h2,
  .problem h3,
  .problem h4 {
    margin: 0.5em 0;
  }

  .problem table {
    margin-bottom: 1em;
  }

  .problem td {
    vertical-align: top;
    padding-right: 0.25em;
  }

  .ide-wrap {
    min-height: 0;
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 8px;
  }

  .pane {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0.1em 0.1em 0.5em rgba(0, 0, 0, 0.2);
    background: #080808;
    padding: 1em;
    min-height: 0;
  }

  .ide {
    --left: 50%;
    --h: 100%;

    min-height: 0;
    height: var(--h);

    display: grid;
    grid-template-columns: var(--left) 10px 1fr;
    gap: 0;
    user-select: none;
  }

  .pane-body,
  #editor,
  #terminal {
    height: 100%;
    min-height: 0;
  }

  .gutter {
    cursor: col-resize;
    border-radius: 999px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.08);
  }

  .gutter:hover {
    background: rgba(255, 255, 255, 0.16);
  }

  .resize-row {
    height: 12px;
    cursor: row-resize;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.06);
  }

  .resize-row:hover {
    background: rgba(0, 0, 0, 0.12);
  }

  .bu-lang img {
    width: 1em;
    height: 1em;
    margin-right: 0.3em;
    object-fit: cover;
    transform: scale(1.25);
  }
  .bu-lang {
    color: #444;
  }
  .bu-lang:disabled img {
    filter: grayscale(100%);
  }
  .bu-lang.btn.active {
    background-color: #e6e7e8!important;
  }
  .bu-light.active {
    border: 1px solid #aaa;
    background-color: #f8f8f8;
  }
  .bu-lang i {
    margin-left: 0.5em;
    margin-right: 0!important;
  }
  #solved-hint {
    border-top: 1px solid rgba(0, 0, 0, 0.15);
    border-bottom: 1px solid rgba(0, 0, 0, 0.15);
    padding: 0.5em 0.5em;
    background-color: rgba(0, 0, 0, 0.05);
  }
  #solved-hint i {
    margin-right: 0.15em;
  }
  .task-overview-lang {
    display: inline-flex;
    gap: 0.25em;
    margin-left: 0.5em;
  }
  .task-overview-lang img {
    width: 1.5em;
    height: 1.5em;
    object-fit: cover;
  }
  .btn-task {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .btn-task:hover {
    background-color: #f8f8f8;
    border: 1px solid #e0e0e0;
  }
</style>

<div class="page">
    <div class="topbar">

        <div class="topbar-left">
            <a href="/">Workspace</a>
            <span>/</span>
            <a href="/codebites">Code Bites</a>
            <span>/</span>
            <a href="/codebites/basics">Basics</a>
        </div>

        <div class="topbar-ide">

            <div class="topbar-editor-left">
                <button id="bu-python" class="btn bu-lang btn-light"><img src='/images/lang/python-128.png' disabled> Python<i class='bi bi-check-lg text-success' style="display: none;"></i></button>
                <button id="bu-ruby" class="btn bu-lang btn-light"><img src='/images/lang/ruby-128.png' disabled> Ruby<i class='bi bi-check-lg text-success' style="display: none;"></i></button>
            </div>

            <div class="topbar-terminal-right">
                <button id="loadBtn"class="btn btn-outline-secondary">
                    <i class='bi bi-clock-history'></i>Laden…
                </button>
                <button id="runBtn"class="btn btn-success" disabled>
                    <i class='bi bi-play-fill'></i>Ausführen
                </button>
                <button id="stopBtn" class="btn btn-outline-secondary" disabled>
                    <i class="bi bi-stop-fill"></i>Stop
                </button>
            </div>

        </div>

    </div>
    <div class="main">
        <div class="problem"></div>

        <div class="ide-wrap" style="grid-column: 2 / span 2;">
            <div id="ide" class="ide">
                <div class="pane">
                    <div class="pane-body" id="editor"></div>
                </div>

                <div id="gutter" class="gutter"
                    title="Drag to resize width"></div>

                <div class="pane">
                    <div class="pane-body" id="terminal"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/include/monaco/package/min/vs/loader.js"></script>
<script>
  var available_languages = ["python", "ruby"];
  var language = "ruby";
  var task = null;
  var codebite = null;
  var editor = null;
  var term = null;
  var starter = null;

  function join_with_sep(arr, sep, final_sep) {
    if (arr.length === 0) return "";
    if (arr.length === 1) return arr[0];
    if (arr.length === 2) return arr[0] + final_sep + arr[1];
    return arr.slice(0, -1).join(sep) + final_sep + arr[arr.length - 1];
  }

  function updateTaskSolved() {
    $('.bu-lang i').hide();
    for (let lang of codebite.solved) {
      $(`#bu-${lang} i`).show();
    }
    $('.problem').find('#solved-hint').remove();
    if (codebite.solved.length > 0) {
      lang_labels = [];
      for (let lang of available_languages) {
        if (codebite.solved.indexOf(lang) !== -1)
          lang_labels.push($(`#bu-${lang}`).text().trim());
      }
      $(`<p id="solved-hint"><i class='bi bi-check-lg text-success' style='transform: scale(1.2);'></i> Du hast diese Aufgabe bereits in ${join_with_sep(lang_labels, ", ", " und ")} gelöst.</p>`).insertAfter($('.problem').find('h2').first());
    }
  }

  function loadTemplate(lang) {
    if (!starter) return;
    let code = starter[lang];
    if (!code) return;

    const marker = "#_";
    const idx = code.indexOf(marker);

    let lineNumber = 1;
    let column = 1;

    if (idx !== -1) {
        // Text before the marker
        const before = code.slice(0, idx);

        // 1-based line number = number of '\n' + 1
        const lines = before.split("\n");
        lineNumber = lines.length;

        // 1-based column = length of last line + 1
        column = lines[lines.length - 1].length + 1;

        // Remove only the first occurrence of the marker
        code = code.slice(0, idx) + code.slice(idx + marker.length);
    }

    editor.setValue(code);
    editor.focus();

    const pos = { lineNumber, column };
    editor.setPosition(pos);
    editor.revealPositionInCenter(pos);
  }

  function reloadPage() {
    let slug = window.location.pathname.split("/codebites")[1];
    task = (slug.split("/")[1] ?? "").trim();
    let sha1 = (slug.split("/")[2] ?? "").trim();
    if (task === "") task = null;
    if (sha1 === "") sha1 = null;

    console.log(`Task: ${task}, SHA1: ${sha1}`);
    if (task === null) {
      $('.bu-lang').attr("disabled", true);
      $('#runBtn').attr("disabled", true);
      $('#stopBtn').attr("disabled", true);
      api_call("/api/codebites_get_tasks", {}, function (data) {
        if (data.success) {
          console.log(data);
          let div = $("<div>");
          for (let section of data.sections) {
            let title_and_icon = $(
              '<div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">'
            );
            title_and_icon.append(`<h3>${section.title}</h3>`);
            title_and_icon.append(
              `<img src="${section.icon}" style="width: 32px; height: 32px;">`
            );
            div.append(title_and_icon);
            // div.append(`<p>${section.description}</p>`);
            for (let entry of section.entries) {
              let heading = data.tasks[entry] ? data.tasks[entry].heading : entry;
              let solved_lang = [];
              for (let lang of available_languages) {
                if ((data.solved_tasks[entry] || []).indexOf(lang) !== -1) {
                  solved_lang.push(`<img src='/images/lang/${lang}-128.png'>`);
                }
              }
              div.append(
                `<a href="/codebites/${entry}" class="btn btn-task w-100">${heading}<div class='task-overview-lang'>${solved_lang.join('')}</div></a>`
              );
            }
          }
          $(".problem").html(div);
        }
      });
    } else {
      api_call("/api/get_codebite", { task: task }, function (data) {
        console.log(data);
        if (data.success) {
          codebite = data.result;
          $(".problem").html(data.result.problem);
          starter = data.result.starter;
          language = data.result.preferred_language;
          loadTemplate(language);
          $(`#bu-${language}`).addClass('active');
          $('#runBtn').attr("disabled", false);
          $('#stopBtn').attr("disabled", true);
          codebite.solved = data.result.solved ?? [];
          updateTaskSolved();
        }
      });
    }
  }

  (function () {
    const ideEl = document.getElementById("ide");
    const gutterEl = document.getElementById("gutter");

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    editor = null;
    term = null;
    let fitAddon = null;

    function relayout() {
      if (editor) editor.layout();
      if (fitAddon) fitAddon.fit();
    }

    (function setupWidthDrag() {
      let dragging = false;

      function onMove(e) {
        if (!dragging) return;

        const rect = ideEl.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = (x / rect.width) * 100;

        ideEl.style.setProperty("--left", clamp(pct, 20, 80) + "%");
        relayout();
      }

      function stop() {
        if (!dragging) return;
        dragging = false;
        document.body.style.cursor = "";
        document.body.style.userSelect = "";
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", stop);
        relayout();
      }

      gutterEl.addEventListener("mousedown", (e) => {
        e.preventDefault();
        dragging = true;
        document.body.style.cursor = "col-resize";
        document.body.style.userSelect = "none";
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", stop);
      });
    })();

    window.addEventListener("resize", () => relayout());

    window.require.config({
      paths: {
        vs: "/include/monaco/package/min/vs",
        xterm: "/include/xterm/xterm",
        "xterm-addon-fit": "/include/xterm/addon-fit",
      },
    });

    window.require(["vs/editor/editor.main", "xterm", "xterm-addon-fit"], function (
      _monacoMain,
      xterm,
      fitMod
    ) {
      editor = monaco.editor.create(document.getElementById("editor"), {
        language: language,
        theme: "vs-dark",
        minimap: { enabled: false },
        tabSize: 4,
        insertSpaces: true,
        automaticLayout: false,
        formatOnPaste: true,
        formatOnType: true,
        autoIndent: "full",
        fontFamily: '"0xProto", monospace',
        fontSize: 15,
        fontLigatures: true,
      });

      function runSubmission() {
        ensureCodebitesWs();
        term.reset();
        api_call("/api/run_codebite", { task: task, language: language, code: editor.getValue() }, function (data) {
            // you can show errors here if request fails
            if (!data || !data.yay) {
                term.write(`\r\n\x1b[31mFailed to start run.\x1b[0m\r\n`);
            } else {
                $('#runBtn').attr("disabled", true).removeClass("btn-success").addClass("btn-outline-secondary");
                $('#stopBtn').attr("disabled", false).removeClass("btn-outline-secondary").addClass("btn-danger");
                term.focus();
            }
        });
      }

      function stopSubmission() {
        ensureCodebitesWs();
        api_call("/api/stop_codebite", { task: task }, function (data) {
            // you can show errors here if request fails
            if (!data || !data.yay) {
                term.write(`\r\n\x1b[31mFailed to stop run.\x1b[0m\r\n`);
            }
        });
      }

      editor.addAction({
        id: "codebites.run",
        label: "Run",
        keybindings: [
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter,
        ],
        precondition: null,
        keybindingContext: null,
        run: runSubmission,
      });

      term = new xterm.Terminal({
        convertEol: true,
        disableStdin: true,
        cursorBlink: false,
        fontFamily: '"0xProto", monospace',
        fontSize: 15,

        theme: {
          background: '#080808',
          foreground: '#D3D7CF',
          cursor:     '#D3D7CF',
          selection:  '#555753',

          black:   '#080808',
          red:     '#8c0c03',
          green:   '#16884a',
          yellow:  '#fdb717',
          blue:    '#3465A4',
          magenta: '#75507B',
          cyan:    '#06989A',
          white:   '#D3D7CF',

          brightBlack:   '#888a85',
          brightRed:     '#d5291a',
          brightGreen:   '#4aa03f',
          brightYellow:  '#FCE94F',
          brightBlue:    '#729FCF',
          brightMagenta: '#AD7FA8',
          brightCyan:    '#55beed',
          brightWhite:   '#EEEEEC'
        }
      });

      fitAddon = new fitMod.FitAddon();
      term.loadAddon(fitAddon);

      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      term.onKey(({ key, domEvent }) => {
        const ev = domEvent;

        // Ctrl+C  → stop current run
        if (ev.ctrlKey && ev.key === "c") {
          ev.preventDefault();
          stopSubmission?.();
          return;
        }

        // Ctrl+Enter / Cmd+Enter → run
        if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") {
          ev.preventDefault();
          runSubmission?.();
          return;
        }

        // // Escape → clear terminal
        // if (ev.key === "Escape") {
        //   ev.preventDefault();
        //   term.reset();
        //   return;
        // }
      });

      window.feedBytes = (bytes) => term.write(bytes);

      document.getElementById("runBtn")?.addEventListener("click", () => {
        runSubmission();
      });

      document.getElementById("stopBtn")?.addEventListener("click", () => {
        stopSubmission?.();
      });

      document.getElementById("loadBtn")?.addEventListener("click", () => {
        api_call("/api/codebite_load_submissions", { task: task }, function (data) {
          console.log(data);
        });
      });

      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          runSubmission();
        }
      });

      relayout();
      reloadPage();

      let codebitesWs = null;

      function ensureCodebitesWs() {
        if (codebitesWs && (codebitesWs.readyState === WebSocket.OPEN || codebitesWs.readyState === WebSocket.CONNECTING)) {
            return;
        }
        const proto = (location.protocol === "https:") ? "wss" : "ws";
        codebitesWs = new WebSocket(`${proto}://${location.host}/ws_codebites`);

        codebitesWs.onmessage = (ev) => {
          let msg = {};
          try { msg = JSON.parse(ev.data); } catch { return; }

          if (msg.action === "codebite_output") {
            // decode base64 to bytes and write to xterm
            const binStr = atob(msg.data_b64);
            const bytes = new Uint8Array(binStr.length);
            for (let i = 0; i < binStr.length; i++) bytes[i] = binStr.charCodeAt(i);
            term.write(bytes);
            return;
          }

          if (msg.action === "codebite_exit") {
            // term.write(`\r\n\x1b[90m[process exited with ${msg.exit_code}]\x1b[0m\r\n`);
            if (msg.exit_code === 0) {
              let language = msg.language;
              if (codebite.solved.indexOf(language) === -1) {
                codebite.solved.push(language);
                updateTaskSolved();
              }
            }
            $('#runBtn').attr("disabled", false).removeClass("btn-outline-secondary").addClass("btn-success");
            $('#stopBtn').attr("disabled", true).removeClass("btn-danger").addClass("btn-outline-secondary");
            editor.focus();
            return;
          }

        //   if (msg.action === "codebite_status") {
        //     term.write(`\r\n\x1b[90m[${msg.status}]\x1b[0m\r\n`);
        //     return;
        //   }

          if (msg.action === "codebite_error") {
            term.write(`\r\n\x1b[31m${msg.message}\x1b[0m\r\n`);
            return;
          }
        };

        codebitesWs.onclose = () => {
            setTimeout(ensureCodebitesWs, 500);
        };
      }

      ensureCodebitesWs();

      $('.bu-lang').on('click', function() {
        const selectedLang = $(this).attr('id').replace('bu-', '');
        if (selectedLang === language) return; // already selected
        api_call('/api/set_preferred_language', { language: selectedLang }, function(data) {
          if (data.success) {
            language = selectedLang;
            $('.bu-lang').removeClass('active');
            $(`#bu-${language}`).addClass('active');
            loadTemplate(language);
          }
        });
      });
    });
  })();
</script>